{% extends "base.html" %}

{% block title %}Quiz Results - ICM MATH CLICKATHON{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/highscores.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="text-center">ICM MATH CLICKATHON Quiz Results</h1>

    <!-- Top 3 positions layout -->
    <div class="top-three">
        <!-- Top row with gold (1st place) -->
        <div class="top-row">
            <div class="position-card first">
                <img src="{{ url_for('static', filename='images/gold.png') }}" alt="Gold Badge">
                <h2>1st Place</h2>
                <p id="sfirst-name"></p>
                <p id="first-name"></p>
                <strong><p id="first-score"></p></strong>
                <strong><p id="first-time"></p></strong>
            </div>
        </div>
        
        <!-- Second row with silver and bronze (2nd and 3rd places) -->
        <div class="second-row">
            <div class="position-card second">
                <img src="{{ url_for('static', filename='images/silver.png') }}" alt="Silver Badge">
                <h2>2nd Place</h2>
                <p id="ssecond-name"></p>
                <p id="second-name"></p>
                <strong><p id="second-score"></p></strong>
                <strong><p id="second-time"></p></strong>
            </div>
            <div class="position-card third">
                <img src="{{ url_for('static', filename='images/bronze.png') }}" alt="Bronze Badge">
                <h2>3rd Place</h2>
                <p id="sthird-name"></p>
                <p id="third-name"></p>
                <strong><p id="third-score"></p></strong>
                <strong><p id="third-time"></p></strong>
            </div>
        </div>
    </div>

    <!-- Table for 4th position onwards -->
    <table class="table mt-5">
        <thead>
            <tr>
                <th>Position</th>
                <th>Group Name</th>
                <th>School Name</th>
                <th>Total Score</th>
                <th>Total Response Time</th>
            </tr>
        </thead>
        <tbody id="resultsTableBody"></tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<!-- Add Canvas Confetti CDN -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get results from localStorage or Flask template variable
        const results = JSON.parse(localStorage.getItem('quizResults')) || {{ results|tojson|safe }};
        
        // Display top 3 positions with animation
        if (results.length > 0) {
            animateResult('first', results[0]);
        }
        if (results.length > 1) {
            setTimeout(() => animateResult('second', results[1]), 300);
        }
        if (results.length > 2) {
            setTimeout(() => animateResult('third', results[2]), 600);
        }

        // Display the rest in the table from 4th position onwards
        const resultsTableBody = document.getElementById('resultsTableBody');
        results.slice(3).forEach((result, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 4}</td>
                <td>${result.group_name}</td>
                <td>${result.school_name}</td>
                <td>${result.total_score}</td>
                <td>${result.total_response_time}</td>
            `;
            row.classList.add('fade-in-row');
            row.style.animationDelay = `${0.2 * index}s`;
            resultsTableBody.appendChild(row);
        });

        // Start confetti for winners
        if (results.length > 0) {
            startConfetti();
        }

        // Clear localStorage after rendering if necessary
        localStorage.removeItem('quizResults');
    });

    function animateResult(position, data) {
        const el = document.getElementById(`${position}-name`);
        const schoolEl = document.getElementById(`s${position}-name`);
        const scoreEl = document.getElementById(`${position}-score`);
        const timeEl = document.getElementById(`${position}-time`);
        
        el.textContent = data.group_name;
        schoolEl.textContent = data.school_name;
        scoreEl.textContent = `Score: ${data.total_score}`;
        timeEl.textContent = `Total Time: ${data.total_response_time}`;
        
        // Add animation class
        const card = document.querySelector(`.position-card.${position}`);
        card.classList.add('animate-in');
    }

    function startConfetti() {
        const confettiSettings = { 
            particleCount: 100, 
            spread: 80, 
            origin: { y: 0.6 } 
        };

        // Initial burst
        confetti(confettiSettings);
        
        // Continuous celebration
        const interval = setInterval(() => {
            confetti({
                ...confettiSettings,
                particleCount: 30  // Fewer particles for subsequent bursts
            });
        }, 2000);

        // Stop after 10 seconds
        setTimeout(() => clearInterval(interval), 10000);
    }
</script>
{% endblock %}